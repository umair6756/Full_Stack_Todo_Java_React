name: Full Stack CI/CD with Security

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  id-token: write   
  contents: read

jobs:
  build-security:
    runs-on: ubuntu-latest

    steps:
     
    # Ô∏è Checkout Code
     
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::971422673599:role/github-ecr-role
        aws-region: us-east-1

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2


     
    #  Frontend Security (React)
     
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm install

    - name: Frontend security audit (npm)
      working-directory: frontend
      run: npm audit --audit-level=high
      continue-on-error: true

     
    #  Backend Security (Java)
     
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Build backend
      working-directory: backend
      run: mvn clean package -DskipTests

     
    #  OWASP Dependency Check
     
    - name: OWASP Dependency Check (Backend)
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: "backend"
        path: backend
        format: "HTML"
      continue-on-error: true

     
    #  Docker Build
     
    - name: Build frontend Docker image
      run: docker build -t frontend-app ./frontend

    - name: Build backend Docker image
      run: docker build -t backend-app ./backend

     
    #  Trivy Security Scan
     
    - name: Trivy scan frontend image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: frontend-app
        severity: HIGH,CRITICAL
        exit-code: 0

    - name: Trivy scan backend image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: backend-app
        severity: HIGH,CRITICAL
        exit-code: 0

    - name: Tag Frontend Docker image
      run: |
        docker tag frontend-app:latest 971422673599.dkr.ecr.us-east-1.amazonaws.com/hafiz-repo:frontend-latest

    - name: Tag Backend Docker image
      run: |
        docker tag backend-app:latest 971422673599.dkr.ecr.us-east-1.amazonaws.com/hafiz-repo:backend-latest

    - name: Push Docker images to ECR
      run: |
        docker push 971422673599.dkr.ecr.us-east-1.amazonaws.com/hafiz-repo:frontend-latest
        docker push 971422673599.dkr.ecr.us-east-1.amazonaws.com/hafiz-repo:backend-latest